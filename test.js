import {
  AbiCoder,
  Contract,
  JsonRpcProvider,
  Wallet,
  ZeroAddress,
  ethers,
} from "ethers";
import dotenv from "dotenv";
dotenv.config();

import VaultAbi from "./ABIs/vault.json" assert { type: "json" };
import DiamondABI from "./ABIs/diamond.json" assert { type: "json" };

const FUNCTIONCALL_TUPLE =
  "tuple(address target_address, bytes[] args, string signature)";

const STEP_TUPLE =
  "tuple(bytes func, uint256[] childrenIndices, bytes[] conditions, bool isCallback)";

const first = AbiCoder.defaultAbiCoder().decode(
  [FUNCTIONCALL_TUPLE],
  "0x00000000000000000000000000000000000000000000000000000000000000200000000000000000000000009ec36eb173d52cdad980b6422d36d5d163375355000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000005e00000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000004c00000000000000000000000000000000000000000000000000000000000000022000076c8c96ea100a2e748b36505b3ce990c5abc5ff817de3f37c65b9b0c080f226a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000ff970a61a04b1ca14834a43f5de4533ebddb5cc80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000342050000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000162050000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000ff970a61a04b1ca14834a43f5de4533ebddb5cc8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001262616c616e63654f6628616464726573732900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024676574496e766573746d656e74416d6f756e742875696e743235362c75696e74323536290000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000620101000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002d737570706c79546f4d61726b657428627974657333322c616464726573732c75696e743235362c62797465732900000000000000000000000000000000000000"
);

// console.log(first);

const provider = new JsonRpcProvider(process.env.ARBITRUM_RPC_URL);
const signer = new Wallet(process.env.PRIVATE_KEY, provider);
const diamond = new Contract(
  "0xbAF45B60F69eCa4616CdE172D3961C156946e831",
  DiamondABI,
  signer
);
const vaultAddress = "0x712F2F0436d22876aCD4c8940f0C23bCbEEFfc2a";

const vaultContract = new Contract(vaultAddress, VaultAbi, provider);

const res = await diamond.fundGasBalance(vaultAddress, {
  value: 2 * 10 ** 15,
});

const receipt = await res.wait();

if (receipt.status) console.log("Funded Vault's Gas Balance...");
else throw "Funding Vault Gas Balance Failed On Hash " + receipt.hash;

const runTxn = await diamond.executeStrategiesTriggers.populateTransaction(
  [10],
  [[true]]
);

const gasLimit = await diamond.executeStrategiesTriggers.estimateGas(
  [10],
  [[true]]
);

runTxn.gasLimit = gasLimit * 4n;

const runRes = await signer.sendTransaction(runTxn);

const runReceipt = await runRes.wait();

if (runReceipt.status)
  console.log(
    "Run Strategy At Hash",
    `https://arbiscan.io/tx/${runReceipt.hash}`
  );
else throw "Couldnt run strategy";

// const res = await vaultContract.getVirtualStepsTree(0);
// console.log("Res", res[1]);
